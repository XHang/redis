# 说明：redis的java连接示例
包括以下教程
1.  


## redis的协议
### 简介：  
redis使用了自家创建的一种叫做RESP（REdis Serialization Protocol） 
虽然这种协议是为redis而创建的，但其实还可以用在其他c/s架构的软件上  
RESP协议具有一些特性   
1. 易于实现  
2. 快速解释  
3. 人类可读  
4. 可以序列化很多数据类型，如整数，字符串，数组，还有它自己定义的错误类型。
注：这仅适用于客户端/服务端通信，集群用的是不同的协议  
注：这个是应用层协议。。  

### 过程：  
客户端发送字符串数组（亦或是字节数组？）作为命令传送到服务端，服务端根据不同的命令返回不同的数据类型。
注：在通信的网络层，用的是TCP协议，端口如果是默认的话，那就是6379  
注：虽然RESP不一定需要TCP协议来支撑它，但是在redis的连接协议上，TCP协议是必不可少的  

### 模型：  
其实就是简单的请求-响应模型，你发一个请求，我收一个请求  
但是有两个例外  
1. jedis提供了管道流，可以批量执行命令而不必等响应过来，协议当然也实现了类似功能。  
	可以发送多个请求，稍后再接受响应  
2. 如果客户单开启了订阅模式，协议会改变发送的语义并成为推送协议。客户端不必再发送命令，因为服务器端会自动向客户端发送数据。。  

### 反馈的数据类型语义：
对于简单字符串，回复的第一个字节是“+”
 对于错误，回复的第一个字节是“ - ”
 对于整数，回复的第一个字节是“：”  
 对于批量字符串，答复的第一个字节是“$”
 对于数组，回复的第一个字节是“*”  
注：在RESP中，协议的不同部分总是以“\ r \ n”（CRLF行终止符）终止  

### 语义举例  
#### 简单的字符串  
简单字符串用下面的格式进行编码：'+',后面加不能换行的字符串，最后以CRLF('\r\n')结尾  
eg:`+ OK\ r\ n`  
当客户端接受到服务端发来的简单字符串的反馈时，客户端应该告诉服务端我收到了  
也就是客户端要发'+'之后的第一个字符组成的字符串，不包括最终的CRLF字符（未确认，需要增强wireshare的抓包能力）


####错误
其实吧，错误类型和简单字符串没什么不同，只是错误类型的前缀不是‘+’，而是‘-’  
基本格式是这个  
`Error message \ r \ n`    
Error是一个通用的错误，事实上，redis服务器还可能发来WRONGTYPE，这是更详的错误类型，其实记它们没什么用，因为这种错误类型随时会变。。  

#### 整数
例如：`：1000 \ r \ n`  
许多redis会返回resp整数，如incr，llen，lastsave  
返回的整数其实没什么意义，但保证会在64位整数的范围内  
整数返回也可以当做true或者false。比如像EXISTS或SISMEMBER这样的命令将返回1为true，0为false。


#### 批量字符串  
这种批量字符串可以表示长达512 MB的单个二进制安全字符串。  
例如字符串“foobar”编码如下  
`$6\r\nfoobar\r\n`  
如果是空字符串的话  
`$0 \ r \ñ\ r\ n`  
如果表示长度为-1，没有数据的话（null  or  Null Bulk String.）  
`$-1\ r\ n`  
#### 数组  
返回数组的命令可以用LRANGE来实验  
数据示例如下  
空数组：`*0\r\n`  
批量字符串“foo”和“bar”的数组:`*2\r\n$3\r\nfoo\r\n$3\r\nbar\r\n`  
如上所示，其实组成数组的元素也是有自己的数据格式的，所以要根据不同数据格式写数组里面的元素  
都这么说了，当然，数组也可以包含不同类型的元素，如下面这个数组有4个整数和一个批量字符串  

	*5\r\n
	:1\r\n
	:2\r\n
	:3\r\n
	:4\r\n
	$6\r\n
	foobar\r\n

为了说明，上面的数据都换行处理了，实际发的数据乱的可以  
然后，数组里面可以包含数组吗？当然可以  

	*2\r\n   --大数组
	*3\r\n	 -- 内部数组1
	:1\r\n
	:2\r\n
	:3\r\n
	*2\r\n 	 --内部数组2
	+Foo\r\n
	-Bar\r\n
	
上面的数组由两个数组构成，一个数组是包含三个整数1,2,3，一个数组包含

现在来看看，数组包含空是怎么肥事  

	*3\r\n
	$3\r\nfoo\r\n
	$-1\r\n
	$3\r\n
	bar\r\n

第二个元素是空。。

####  c/s对话  
大概数据类型就是以上。你现在一个可以自己开发一个简单redis客户端了。我们要演练一下吧    
客户端发送命令LLEN mylist以获取存储在key  mylist的List长度，并且服务器使用Integer数据类型进行回复    
以下：C：客户端，S：服务器  
    
	C：* 2 \ r \ n
	C：$ 4 \ r \ n
	C：LLEN \ r \ n
	C：$ 6 \ r \ n
	C：mylist \ r \ n
	
	S：：48293 \ r \ n
	
是不是很简单，你用抓包软件看下会这么简单吗？`*2\r\n$4\r\nLLEN\r\n$6\r\nmylist\r\n`   疯了没？   


#### 其他  
还有流水线命令，就是客户端一次可以发多遍命令的那个东西，不讲。有兴趣自己去官网撸，地址是   
`https://redis.io/topics/pipelining`
还有简单的telnet会话做客户端   
没意思，不讲  
协议部分完毕，over  

## 问题汇总：
1. 第一次安装，连接报错。报错内容非常清楚，去除安全模式或者设置用户名密码   
介绍下使用配置模式去掉redis的安全模式。
第一步: 打开redis的配置文件 redis.conf  
第二步：编辑`bind  127.0.0.1`为`bind  0.0.0.0`  
第三步：编辑`protected-mode yes`为`protected-mode no`  
第四步：保存并退出  
第五步：使用配置文件启动redsi-server:`./src/redis-server redis.conf &`

2.怎么设置redis的连接密码  
还是编辑   `redis.conf`    ，将 `requirepass foobared`注释去掉  
`foobared`填写自己的密码  
注意1：  
一旦设置了密码，要用jedis连接redis进行ser/get操作前，要执行jedis.auth(String password);  进行密码验证  
注意2：   
哪怕是本地执行redis命令，也需要执行以下命令才可以操作redis  
`auth password`  
或者在进入客户端时指定认证密码  
`redis-cli -a password`  

3. 如何用redis客户端连其他主机的redis  
`redis-cli -a password -p port -h host`  

## redis集群
注：本教程需要redis3.0以上版本
### redis集群能干什么？  
1. 数据分片，就是说，存入redis的数据可以分发在集群的每一台服务器上，减轻主服务器负担
2. 更高的数据可用性，一台redis分支服务器挂了，千千万台redis服务器站出来了  

	通用知识：
	每一个集群的redis节点都应该打开两个TCP连接，一个tcp端口用于于客户端连接，一个tcp端口用于集群总线，通常用来于故障检测，配置更新，故障转移授权等 .要确保这两个端口是开放.

### 要使集群正常工作，需要搞定
1.   集群总线端口必须在任何节点都能够ping通
2.  用于与客户端进行通信的普通客户端通信端口（通常为6379）对所有需要到达集群的客户端加上所有其他集群节点（使用客户端端口进行密钥迁移）。不懂。。

### 集群的几个配置参数
cluster-enabled <yes/no>  yes使用集群模式，no就是独立模式了
cluster-node-timeout <milliseconds>  子节点不可达的超时时间

### 创建一个简单的集群
注意：按预期工作的最小集群需要至少包含三个主节点.  

1. 首先写集群配置文件

	port 7000
	cluster-enabled yes	
	cluster-config-file nodes.conf  --这个文件不用创建，启动时由Redis Cluster实例生成，并由他更新
	cluster-node-timeout 5000
	appendonly yes

2. 创建文件夹来存放配置文件
建议结构如下
		--/redis-4.0.1/cluster
						  --/  7001
						  --/  7002
						   --/  7003
						    --/  7004
 